# roles/minecraft/tasks/install.yml
# Downloads the latest Minecraft Bedrock server and installs the shared binary.
---
- name: Install Bedrock server dependencies
  apt:
    name:
      - curl
      - unzip
      - libcurl4
      - libssl3
    state: present

- name: Create minecraft group
  group:
    name: "{{ minecraft_group }}"
    system: yes

- name: Create minecraft system user
  user:
    name: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    system: yes
    shell: /usr/sbin/nologin
    home: "{{ minecraft_base_dir }}"
    create_home: no

- name: Create directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0755'
  loop:
    - "{{ minecraft_base_dir }}"
    - "{{ minecraft_base_dir }}/bin"
    - "{{ minecraft_base_dir }}/scripts"
    - "{{ minecraft_backup_dir }}"
    - "{{ minecraft_base_dir }}/tmp"

- name: Create server instance directories
  file:
    path: "{{ minecraft_base_dir }}/servers/{{ item.name }}"
    state: directory
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0755'
  loop: "{{ minecraft_servers }}"

# Use manual override if set, otherwise attempt to scrape minecraft.net
- name: Use manual download URL override
  set_fact:
    bedrock_resolved_url: "{{ minecraft_bedrock_download_url }}"
  when: minecraft_bedrock_download_url | default('') | length > 0

- name: Fetch latest Bedrock server download URL from minecraft.net
  shell: |
    python3 - <<'PYEOF'
    import urllib.request, re, json, sys

    PAGE_URL   = "https://www.minecraft.net/en-us/download/server/bedrock"
    LINUX_BASE = "https://www.minecraft.net/bedrockdedicatedserver/bin-linux"
    UA         = ("Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                  "AppleWebKit/537.36 (KHTML, like Gecko) "
                  "Chrome/120.0.0.0 Safari/537.36")

    FULL_RE    = re.compile(r'https?://[^\s"\'<>]*/bin-linux/bedrock-server-[\d.]+\.zip')
    VERSION_RE = re.compile(r'bedrock-server-([\d]+\.[\d]+\.[\d]+\.[\d]+)\.zip')

    def find_url(text):
        m = FULL_RE.search(text)
        if m:
            return m.group(0)
        m = VERSION_RE.search(text)
        if m:
            return f"{LINUX_BASE}/bedrock-server-{m.group(1)}.zip"
        return None

    headers = {
        "User-Agent":      UA,
        "Accept":          "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Accept-Language": "en-US,en;q=0.5",
    }
    try:
        req  = urllib.request.Request(PAGE_URL, headers=headers)
        resp = urllib.request.urlopen(req, timeout=30)
        html = resp.read().decode("utf-8", errors="ignore")
        print(f"DEBUG: HTTP {resp.status}, page length {len(html)} chars", file=sys.stderr)
    except Exception as e:
        print(f"ERROR fetching page: {e}", file=sys.stderr)
        sys.exit(1)

    result = find_url(html)
    if result:
        print(result); sys.exit(0)

    nd = re.search(r'<script[^>]*id=["\']__NEXT_DATA__["\'][^>]*>(.*?)</script>', html, re.DOTALL)
    if nd:
        try:
            result = find_url(json.dumps(json.loads(nd.group(1))))
            if result:
                print(result); sys.exit(0)
        except Exception:
            pass

    for block in re.findall(r'<script[^>]*>(.*?)</script>', html, re.DOTALL):
        result = find_url(block)
        if result:
            print(result); sys.exit(0)

    print(f"DEBUG: page snippet: {html[:500]}", file=sys.stderr)
    sys.exit(1)
    PYEOF
  register: bedrock_url_fetch
  changed_when: false
  check_mode: no
  when: minecraft_bedrock_download_url | default('') | length == 0

- name: Set download URL from scraped result
  set_fact:
    bedrock_resolved_url: "{{ bedrock_url_fetch.stdout }}"
  when: minecraft_bedrock_download_url | default('') | length == 0

- name: Fail if no download URL could be determined
  fail:
    msg: |
      Could not determine the Minecraft Bedrock download URL automatically.
      Set 'minecraft_bedrock_download_url' in ansible/inventory/group_vars/all/minecraft.yml:
        minecraft_bedrock_download_url: "https://www.minecraft.net/bedrockdedicatedserver/bin-linux/bedrock-server-X.X.X.X.zip"
      Find the latest URL at: https://www.minecraft.net/en-us/download/server/bedrock
  when: bedrock_resolved_url | default('') | length == 0

- name: Extract version from download URL
  set_fact:
    bedrock_latest_version: "{{ bedrock_resolved_url | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+') }}"

- name: Check if version file exists
  stat:
    path: "{{ minecraft_base_dir }}/current_version"
  register: version_file_stat

- name: Read currently installed version
  slurp:
    src: "{{ minecraft_base_dir }}/current_version"
  register: installed_version_file
  when: version_file_stat.stat.exists

- name: Set installed version fact
  set_fact:
    bedrock_installed_version: "{{ (installed_version_file.content | b64decode | trim) if version_file_stat.stat.exists else '0.0.0.0' }}"

- name: Download Bedrock server zip
  get_url:
    url: "{{ bedrock_resolved_url }}"
    dest: "{{ minecraft_base_dir }}/tmp/bedrock-server.zip"
    mode: '0644'
  when: bedrock_latest_version != bedrock_installed_version

- name: Extract Bedrock binary and libraries to shared bin/
  unarchive:
    src: "{{ minecraft_base_dir }}/tmp/bedrock-server.zip"
    dest: "{{ minecraft_base_dir }}/bin"
    remote_src: yes
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
  when: bedrock_latest_version != bedrock_installed_version

- name: Make bedrock_server binary executable
  file:
    path: "{{ minecraft_base_dir }}/bin/bedrock_server"
    mode: '0755'
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
  when: bedrock_latest_version != bedrock_installed_version

- name: Write installed version file
  copy:
    content: "{{ bedrock_latest_version }}"
    dest: "{{ minecraft_base_dir }}/current_version"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
  when: bedrock_latest_version != bedrock_installed_version

- name: Clean up downloaded zip
  file:
    path: "{{ minecraft_base_dir }}/tmp/bedrock-server.zip"
    state: absent

# Bedrock looks for resource_packs/ and behavior_packs/ relative to its
# working directory. Symlink them from the shared bin/ into each instance.
# If a prior Bedrock run created empty directories in place, remove them first.
- name: Symlink resource_packs and behavior_packs into each server instance
  shell: |
    for pack in resource_packs behavior_packs; do
      DEST="{{ minecraft_base_dir }}/servers/{{ item.name }}/${pack}"
      SRC="{{ minecraft_base_dir }}/bin/${pack}"
      if [ ! -L "${DEST}" ]; then
        rm -rf "${DEST}"
        ln -s "${SRC}" "${DEST}"
      fi
    done
  loop: "{{ minecraft_servers }}"
  changed_when: false

- name: Set server.properties for each instance
  template:
    src: server.properties.j2
    dest: "{{ minecraft_base_dir }}/servers/{{ item.name }}/server.properties"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
  loop: "{{ minecraft_servers }}"

- name: Create default allowlist.json for each instance
  copy:
    content: "[]"
    dest: "{{ minecraft_base_dir }}/servers/{{ item.name }}/allowlist.json"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
    force: no
  loop: "{{ minecraft_servers }}"

- name: Create default permissions.json for each instance
  copy:
    content: "[]"
    dest: "{{ minecraft_base_dir }}/servers/{{ item.name }}/permissions.json"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
    force: no
  loop: "{{ minecraft_servers }}"
