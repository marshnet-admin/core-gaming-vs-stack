# roles/minecraft/tasks/install.yml
# Downloads the latest Minecraft Bedrock server and installs the shared binary.
---
- name: Install Bedrock server dependencies
  apt:
    name:
      - curl
      - unzip
      - libcurl4
      - libssl3
    state: present

- name: Create minecraft group
  group:
    name: "{{ minecraft_group }}"
    system: yes

- name: Create minecraft system user
  user:
    name: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    system: yes
    shell: /usr/sbin/nologin
    home: "{{ minecraft_base_dir }}"
    create_home: no

- name: Create directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0755'
  loop:
    - "{{ minecraft_base_dir }}"
    - "{{ minecraft_base_dir }}/bin"
    - "{{ minecraft_base_dir }}/scripts"
    - "{{ minecraft_backup_dir }}"
    - "{{ minecraft_base_dir }}/tmp"

- name: Create server instance directories
  file:
    path: "{{ minecraft_base_dir }}/servers/{{ item.name }}"
    state: directory
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0755'
  loop: "{{ minecraft_servers }}"

- name: Fetch latest Bedrock server download URL
  shell: |
    python3 - <<'PYEOF'
    import urllib.request, re, json, sys

    UA = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    URL = "https://www.minecraft.net/en-us/download/server/bedrock"
    PATTERN = re.compile(r'https://[^\s"\'<>]*bin-linux[^\s"\'<>]*bedrock-server-[\d.]+\.zip')

    try:
        req = urllib.request.Request(URL, headers={"User-Agent": UA})
        html = urllib.request.urlopen(req, timeout=30).read().decode("utf-8", errors="ignore")
    except Exception as e:
        print(f"ERROR fetching page: {e}", file=sys.stderr)
        sys.exit(1)

    # Pass 1: direct regex match anywhere in raw HTML
    m = PATTERN.search(html)
    if m:
        print(m.group(0))
        sys.exit(0)

    # Pass 2: extract from embedded __NEXT_DATA__ JSON (Next.js pages)
    nd = re.search(r'<script[^>]*id=["\']__NEXT_DATA__["\'][^>]*>(.*?)</script>', html, re.DOTALL)
    if nd:
        try:
            m = PATTERN.search(json.dumps(json.loads(nd.group(1))))
            if m:
                print(m.group(0))
                sys.exit(0)
        except Exception:
            pass

    sys.exit(1)
    PYEOF
  register: bedrock_download_url
  changed_when: false
  check_mode: no

- name: Fail if download URL not found
  fail:
    msg: "Could not determine latest Minecraft Bedrock download URL. Check connectivity to minecraft.net."
  when: bedrock_download_url.stdout | length == 0

- name: Extract version from download URL
  set_fact:
    bedrock_latest_version: "{{ bedrock_download_url.stdout | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+') }}"

- name: Read currently installed version
  slurp:
    src: "{{ minecraft_base_dir }}/current_version"
  register: installed_version_file
  ignore_errors: yes

- name: Set installed version fact
  set_fact:
    bedrock_installed_version: "{{ (installed_version_file.content | b64decode | trim) if installed_version_file is succeeded else '0.0.0.0' }}"

- name: Download Bedrock server zip
  get_url:
    url: "{{ bedrock_download_url.stdout }}"
    dest: "{{ minecraft_base_dir }}/tmp/bedrock-server.zip"
    mode: '0644'
  when: bedrock_latest_version != bedrock_installed_version

- name: Extract Bedrock binary and libraries to shared bin/
  unarchive:
    src: "{{ minecraft_base_dir }}/tmp/bedrock-server.zip"
    dest: "{{ minecraft_base_dir }}/bin"
    remote_src: yes
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
  when: bedrock_latest_version != bedrock_installed_version

- name: Make bedrock_server binary executable
  file:
    path: "{{ minecraft_base_dir }}/bin/bedrock_server"
    mode: '0755'
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
  when: bedrock_latest_version != bedrock_installed_version

- name: Write installed version file
  copy:
    content: "{{ bedrock_latest_version }}"
    dest: "{{ minecraft_base_dir }}/current_version"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
  when: bedrock_latest_version != bedrock_installed_version

- name: Clean up downloaded zip
  file:
    path: "{{ minecraft_base_dir }}/tmp/bedrock-server.zip"
    state: absent

- name: Set server.properties for each instance
  template:
    src: server.properties.j2
    dest: "{{ minecraft_base_dir }}/servers/{{ item.name }}/server.properties"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
  loop: "{{ minecraft_servers }}"

- name: Create default allowlist.json for each instance
  copy:
    content: "[]"
    dest: "{{ minecraft_base_dir }}/servers/{{ item.name }}/allowlist.json"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
    force: no
  loop: "{{ minecraft_servers }}"

- name: Create default permissions.json for each instance
  copy:
    content: "[]"
    dest: "{{ minecraft_base_dir }}/servers/{{ item.name }}/permissions.json"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: '0644'
    force: no
  loop: "{{ minecraft_servers }}"
